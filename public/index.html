<!DOCTYPE html>

<html lang="pt-br">
<head>
	<link rel="stylesheet" type="text/css" href="style.css"> 
	<link rel="stylesheet" type="text/css" href="titles.css"> 
	<link rel="stylesheet" type="text/css" href="menus.css"> 
	<link rel="stylesheet" type="text/css" href="forms.css"> 
	<link rel="stylesheet" type="text/css" href="animal_details.css">

	<meta charset="utf-8">

	<title>Pet Shop</title>
</head>
<body>
	<header>
		<h1 class="site_title">Pet Shop</h1>
	</header>

	<nav>
		<ul class="horizontal_menu">
		</ul>
	</nav>
	<main class="content">

	</main>
 	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="site_content.js"></script>

 	<script>
	var connection;
	var connectedUser;

	// Admin Variables
	let adminScheduledServices = [];
	let adminUsers = [];
	let adminServiceTypes = [];
	let adminAnimals = [];
	let adminProducts = [];

	// User Variables
	let userCart = {};
	let userProducts =[];

	$(document).ready(
		function() {
			$(".horizontal_menu").html(horizontalMenu.index)
			$(".content").html(siteContent.index);
			$('#login_form').submit(function(e) {
				e.preventDefault();
				loginClick();
			});
		}
	);

	function loginClick() {
		const usernameValue = document.getElementById("login_username").value;
		const passwordValue = document.getElementById("login_password").value;
		const data = JSON.stringify({user: usernameValue, password: passwordValue});
		$.ajax({
	        type: 'post',
	        contentType: 'application/json',
	        url: 'login',
	        data: data,
	        success: function(response) {
	       		console.log(response);
	       		connectedUser = response.data;
	       		if (connectedUser.isAdmin) {
					$(".horizontal_menu").html(horizontalMenu.admin);
					adminShowRegisterArea();
				} else {
					$(".horizontal_menu").html(horizontalMenu.client);
					showAnimalManager();
				}
				setWelcomeMessageName(connectedUser.nome);
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function logoutClick() {
		connectedUser = null;
		adminScheduledServices = [];
		adminUsers = [];
		adminServiceTypes = [];
		adminAnimals = [];
		adminProducts = [];

		userCart = {};
		userProducts =[];
		$("#user_login_box").remove();
		$(".content").html(siteContent.index);
		$(".horizontal_menu").html(horizontalMenu.index);
		$('#login_form').on('submit', function(e){
			e.preventDefault();
			loginClick();
		});
	}

	function setWelcomeMessageName(name) {
		$("#user_login_box").remove();
		$("header").append(siteContent.logoutBox);
		$("#welcome_span").html($("#welcome_span").html().replace("user_name", name));
		$('#logout').click(function(e){
			e.preventDefault();
			logoutClick();
		});
	}

	// Admin Functions
	function adminMenuClick(component) {
		switch(component.attributes.tab.value) {
			case "novosCadastros":
				adminShowRegisterArea();
				break;
			case "servicosAgendados":
				adminShowScheduledServices();
				break;
			case "controleDeEstoque":
				adminShowProducts();
				break;
		}
	}

	function adminShowRegisterArea() {
		$(".content").html(siteContent.admin.novosCadastros);
		document.getElementById("new_user_form").style.display = "none";
		document.getElementById("new_product_form").style.display = "none";
		document.getElementById("new_service_form").style.display = "none";

		$("#new_user_button").click(function(e) {
			e.preventDefault();
			document.getElementById("new_user_form").style.display = "initial";
			document.getElementById("new_product_form").style.display = "none";
			document.getElementById("new_service_form").style.display = "none";

			document.getElementById("register_username").value = "";
			document.getElementById("register_name").value = "";
			document.getElementById("register_address_phone").value = "";
			document.getElementById("register_address_email").value = "";
			document.getElementById("register_address_city").value = "";
			document.getElementById("register_address_neighborhood").value = "";
			document.getElementById("register_address_street").value = "";
			document.getElementById("register_password").value = "";
			document.getElementById("register_repeat_password").value = "";
		});
		$("#new_product_button").click(function(e) {
			e.preventDefault();
			document.getElementById("new_user_form").style.display = "none";
			document.getElementById("new_product_form").style.display = "initial";
			document.getElementById("new_service_form").style.display = "none";

			document.getElementById("register_product_name").value = "";
			document.getElementById("register_product_description").value = "";
		});
		$("#new_service_button").click(function(e) {
			e.preventDefault();
			document.getElementById("new_user_form").style.display = "none";
			document.getElementById("new_product_form").style.display = "none";
			document.getElementById("new_service_form").style.display = "initial";

			document.getElementById("register_service_name").value = "";
			document.getElementById("register_service_price").value = "";
		});

		$("#new_user_form").on('submit', function(e) {
			e.preventDefault();

			let username = document.getElementById("register_username").value;
			let name = document.getElementById("register_name").value;
			let phone = document.getElementById("register_address_phone").value;
			let email = document.getElementById("register_address_email").value;
			let city = document.getElementById("register_address_city").value;
			let neighborhood = document.getElementById("register_address_neighborhood").value;
			let street = document.getElementById("register_address_street").value;
			let password = document.getElementById("register_password").value;
			let repeatPassword = document.getElementById("register_repeat_password").value;
			let isAdmin = document.getElementById("register_is_admin").checked;

			if (username.length == 0) {
				alert("Por favor insira um nome de usuário");
			} else if (name.length == 0) {
				alert("Por favor insira um nome");
			} else if (phone.length == 0) {
				alert("Por favor insira um telefone");
			} else if (email.length == 0) {
				alert("Por favor insira um email");
			} else if (password.length == 0) {
				alert("Por favor insira uma senha");
			} else if (password != repeatPassword) {
				alert("As senhas inseridas são diferentes");
			} else {
				let user = {
					user: username.toLowerCase(),
					name: name,
					password: password,
					repeatPassword: repeatPassword,
					email: email,
					phone: phone,
					city: city,
					street: street,
					neighborhood: neighborhood,
					isAdmin: isAdmin
				};
				const data = JSON.stringify(user);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: 'new_user',
			        data: data,
			        success: function(response) {
						alert(response.message);
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});

		$("#new_product_form").on('submit', function(e) {
			e.preventDefault();

			let name = $("#register_product_name").val();
			let description = $("#register_product_description").val();
			let price = $("#register_product_price").val();
			let quantity = $("#register_product_quantity").val();

			if (name.length == 0) {
				alert("Insira um nome para o produto");
			} else if (typeof price == 'undefined' || price == null || price.length == 0) {
				alert("Insira um preço");
			} else if (typeof quantity == 'undefined' || quantity == null || quantity.length == 0) {
				alert("Insira uma quantidade");
			} else {
				let productInfo = {
					name: name,
					description: description,
					price: Number(price),
					quantity: Number(quantity)
				};
				const data = JSON.stringify(productInfo);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: 'new_product',
			        data: data,
			        success: function(response) {
						alert(response.message);
						$("#new_product_name").val("");
						$("#new_product_description").val("");
						$("#new_product_price").val("");
						$("#new_product_quantity").val("");
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});

		$("#new_service_form").on('submit', function(e) {
			e.preventDefault();
			let name = document.getElementById("register_service_name").value;
			let price = document.getElementById("register_service_price").value;

			if (name.length == 0) {
				alert("Por favor insira um nome")
			} else if (price.length == 0) {
				alert("Por favor insira um preço")
			} else {
				let serviceTypeInfo = {
					name: name,
					price: Number(price)
				};
				const data = JSON.stringify(serviceTypeInfo);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: 'new_service_type',
			        data: data,
			        success: function(response) {
						alert(response.message);
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});
	}

	function adminShowScheduledServices() {
		$(".content").html(siteContent.admin.servicosAgendados);
		let usersPromise = new Promise(function(resolve, reject) {
			let tx = connection.transaction(databaseUsersName, "readonly");
			let objectStore = tx.objectStore(databaseUsersName);
			let request = objectStore.getAll();
			request.onsuccess = function(e) {
				let users = e.target.result;
				if (typeof users != 'undefined') {
					let usersSelect = document.getElementById("user_select");
					users.forEach(function(user) {
						let option = document.createElement('option');
						option.value = user.usuario;
						option.text = user.nome;

						usersSelect.append(option);
					});
					resolve(users);
				} else {
					resolve([]);
				}
			};

			request.onerror = function(e) {
				resolve([]);
			};
		});

		let serviceTypesPromise = new Promise(function(resolve, reject) {
			let tx = connection.transaction(databaseServiceTypesName, "readonly");
			let objectStore = tx.objectStore(databaseServiceTypesName);
			let request = objectStore.getAll();
			request.onsuccess = function(e) {
				let serviceTypes = e.target.result;
				if (typeof serviceTypes != 'undefined') {
					let serviceTypeSelect = document.getElementById("service_type_select");
					serviceTypes.forEach(function(serviceType) {
						let option = document.createElement('option');
						option.value = serviceType.id;
						option.text = serviceType.nome;

						serviceTypeSelect.append(option);
					});
					resolve(serviceTypes);
				} else {
					resolve([]);
				}
			};

			request.onerror = function(e) {
				resolve([]);
			};
		});

		let animalsPromise = new Promise(function(resolve, reject) {
			let tx = connection.transaction(databasePetsName, "readonly");
			let objectStore = tx.objectStore(databasePetsName);
			let request = objectStore.getAll();

			request.onsuccess = function(e) {
				let animals = e.target.result;
				if (typeof animals != 'undefined') {
					let animalSelect = document.getElementById("animal_select");
					animals.forEach(function(animal) {
						let option = document.createElement('option');
						option.value = animal.id;
						option.text = animal.nome;

						animalSelect.append(option);
					});
					resolve(animals);
				} else {
					resolve([]);
				}
			};

			request.onerror = function(e) {
				resolve([]);
			};
		});

		Promise.all([usersPromise, serviceTypesPromise, animalsPromise]).then(function(values) {
			adminUsers = values[0];
			adminServiceTypes = values[1];
			adminAnimals = values[2];
			let tx = connection.transaction(databaseScheduledServicesName, "readwrite");
			let objectStore = tx.objectStore(databaseScheduledServicesName);
			let request = objectStore.getAll();
			request.onsuccess = function(e) {
				let scheduledServicesAux = e.target.result;
				if (typeof scheduledServicesAux == 'undefined') {
					adminScheduledServices = [];
					return;
				}
				adminScheduledServices = scheduledServicesAux;

				adminBuildScheduledServiceTable();

				$("#user_select").change(function() {
					adminBuildScheduledServiceTable();
				});

				$("#service_type_select").change(function() {
					adminBuildScheduledServiceTable();
				});

				$("#animal_select").change(function() {
					adminBuildScheduledServiceTable();
				});
			};
		});
	}

	function adminBuildScheduledServiceTable() {
		let usuario = $("#user_select").val();
		let serviceTypeId = Number($("#service_type_select").val());
		let animalId = Number($("#animal_select").val());
		let scheduledServicesAux = adminScheduledServices;
		if (serviceTypeId != null && serviceTypeId >= 0) {
			scheduledServicesAux = scheduledServicesAux.filter(function(scheduledService) {
				return scheduledService.servico == serviceTypeId;
			});
		}
		if (animalId != null && animalId >= 0) {
			scheduledServicesAux = scheduledServicesAux.filter(function(scheduledService) {
				return scheduledService.animal == animalId;
			});
		}
		if (usuario != null && usuario.length > 0) {
			scheduledServicesAux = scheduledServicesAux.filter(function(scheduledService) {
				let animal = adminAnimals.find(function(animal) {
					return animal.id == scheduledService.animal;
				});
				if (typeof animal == 'undefined') {
					return false;
				}
				return animal.dono == usuario;
			});
		}

		let servicesTable = document.getElementById("service_table");
		servicesTable.innerHTML = "";
		if (scheduledServicesAux.length > 0) {
			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderAnimalName = document.createElement('th');
			tableHeaderAnimalName.innerHTML = "Animal";

			let tableHeaderAnimalDono = document.createElement('th');
			tableHeaderAnimalDono.innerHTML = "Dono";

			let tableHeaderServiceName = document.createElement('th');
			tableHeaderServiceName.innerHTML = "Serviço";

			let tableHeaderServiceDate = document.createElement('th');
			tableHeaderServiceDate.innerHTML = "Dia";

			let tableHeaderServiceTime = document.createElement('th');
			tableHeaderServiceTime.innerHTML = "Hora";

			servicesTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderAnimalName);
			tableHeaderRow.append(tableHeaderAnimalDono);
			tableHeaderRow.append(tableHeaderServiceName);
			tableHeaderRow.append(tableHeaderServiceDate);
			tableHeaderRow.append(tableHeaderServiceTime);

			scheduledServicesAux.forEach(function (scheduledService) {
				let serviceType = adminServiceTypes.find(function(service) {
					return scheduledService.servico == service.id;
				});
				let animal = adminAnimals.find(function(animal) {
					return scheduledService.animal == animal.id;
				});

				if (typeof serviceType == 'undefined' || typeof animal == 'undefined') {
					return;
				}

				let dono = adminUsers.find(function(user) {
					return user.usuario == animal.dono;
				});

				if (typeof dono == 'undefined') {
					return;
				}

				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataAnimalName = document.createElement('td');
				tableDataAnimalName.setAttribute('class', "service_table_data");
				tableDataAnimalName.innerHTML = animal.nome;

				let tableDataAnimalDono = document.createElement('td');
				tableDataAnimalDono.setAttribute('class', "service_table_data");
				tableDataAnimalDono.innerHTML = dono.nome;

				let tableDataServiceName = document.createElement('td');
				tableDataServiceName.setAttribute('class', "service_table_data");
				tableDataServiceName.innerHTML = serviceType.nome;

				let tableDataServiceDate = document.createElement('td');
				tableDataServiceDate.setAttribute('class', "service_table_data");
				tableDataServiceDate.innerHTML = scheduledService.data;

				let tableDataServiceTime = document.createElement('td');
				tableDataServiceTime.setAttribute('class', "service_table_data");
				tableDataServiceTime.innerHTML = scheduledService.hora;

				let serviceA = document.createElement('a');
				serviceA.setAttribute('onclick','adminDeleteScheduledService(' + scheduledService.id + ')');

				let serviceDeleteImage = document.createElement('img');
				serviceDeleteImage.src = "icons/delete.png";
				serviceDeleteImage.width = 18;
				serviceDeleteImage.height = 18;
				serviceDeleteImage.style.paddingTop = "4px";

				servicesTable.append(tableRow);
				tableRow.append(tableDataAnimalName);
				tableRow.append(tableDataAnimalDono);
				tableRow.append(tableDataServiceName);
				tableRow.append(tableDataServiceDate);
				tableRow.append(tableDataServiceTime);
				tableRow.append(serviceA);
				serviceA.append(serviceDeleteImage);
			});
		} else {
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoService = document.createElement('td');
			tableDataNoService.innerHTML = "Nenhum serviço encontrado";

			servicesTable.append(tableRow);
			servicesTable.append(tableDataNoService);
		}
	}

	function adminDeleteScheduledService(scheduledServiceId) {
		if (typeof scheduledServiceId == 'undefined' || scheduledServiceId == null) {
			return;
		}

		if (window.confirm("Deseja deletar esse agendamento?")) {
			let tx = connection.transaction(databaseScheduledServicesName, "readwrite");
			let objectStore = tx.objectStore(databaseScheduledServicesName);
			let request = objectStore.delete(scheduledServiceId);
			request.onsuccess = function(e) {
				adminScheduledServices = adminScheduledServices.filter(function(scheduledService) {
					return scheduledService.id != scheduledServiceId;
				});
				adminBuildScheduledServiceTable();
			};

			request.onerror = function(e) {
				alert("Falha ao deletar agendamento")
			}
		}
	}

	function adminShowProducts() {
		$(".content").html(siteContent.admin.controleDeEstoque);
		let tx = connection.transaction(databaseProductsName, "readonly");
		let objectStore = tx.objectStore(databaseProductsName);
		let request = objectStore.getAll();

		request.onsuccess = function(e) {
			let products = e.target.result;
			if (typeof products == 'undefined') {
				adminProducts = [];
				return;
			}
			adminProducts = products;
			adminBuildProductsTable();

			$("#sort_by_select").change(function() {
				adminBuildProductsTable();
			});

			$("#sort_order_select").change(function() {
				adminBuildProductsTable();
			});
		}
	}

	function adminBuildProductsTable() {
		let productsTable = document.getElementById("product_table");
		let sortBy = $("#sort_by_select").val();
		let sortPriority = $("#sort_order_select").val();

		let products = adminProducts.sort(function(product1, product2) {
			switch (sortBy) {
				case "nome":
					return (sortPriority == "crescente") ? product1.nome > product2.nome : product1.nome < product2.nome;
					break;

				case "preco":
					return (sortPriority == "crescente") ? product1.preco > product2.preco : product1.preco < product2.preco;
					break;

				case "quantidade":
					return (sortPriority == "crescente") ? product1.quantidade > product2.quantidade : product1.quantidade < product2.quantidade;
					break;
			}
		});

		productsTable.innerHTML = "";
		if (products.length > 0) {
			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderProductName = document.createElement('th');
			tableHeaderProductName.innerHTML = "Produto";

			let tableHeaderProductPrice = document.createElement('th');
			tableHeaderProductPrice.innerHTML = "Preço";

			let tableHeaderProductQuantity = document.createElement('th');
			tableHeaderProductQuantity.innerHTML = "Quantidade";

			productsTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderProductName);
			tableHeaderRow.append(tableHeaderProductPrice);
			tableHeaderRow.append(tableHeaderProductQuantity);

			products.forEach(function(product) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataProductName = document.createElement('td');
				tableDataProductName.setAttribute('class', "service_table_data");
				tableDataProductName.innerHTML = product.nome;

				let tableDataProductPrice = document.createElement('td');
				tableDataProductPrice.setAttribute('class', "service_table_data");
				tableDataProductPrice.innerHTML = "R$ " + Number(product.preco).toFixed(2);

				let tableDataProductQuantity = document.createElement('td');
				tableDataProductQuantity.setAttribute('class', "service_table_data");
				tableDataProductQuantity.innerHTML = product.quantidade;

				let productEditA = document.createElement('a');
				productEditA.setAttribute('onclick','adminEditProduct(' + product.id + ')');

				let productEditImage = document.createElement('img');
				productEditImage.src = "icons/edit.png";
				productEditImage.width = 18;
				productEditImage.height = 18;
				productEditImage.style.paddingTop = "4px";
				productEditImage.style.paddingRight = "4px";

				let productDeleteA = document.createElement('a');
				productDeleteA.setAttribute('onclick','adminDeleteProduct(' + product.id + ')');

				let productDeleteImage = document.createElement('img');
				productDeleteImage.src = "icons/delete.png";
				productDeleteImage.width = 18;
				productDeleteImage.height = 18;
				productDeleteImage.style.paddingTop = "4px";

				productsTable.append(tableRow);
				tableRow.append(tableDataProductName);
				tableRow.append(tableDataProductPrice);
				tableRow.append(tableDataProductQuantity);
				tableRow.append(productEditA);
				productEditA.append(productEditImage);
				tableRow.append(productDeleteA);
				productDeleteA.append(productDeleteImage);
			});
		} else {
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoProducts = document.createElement('td');
			tableDataNoProducts.setAttribute('class', "service_table_data");
			tableDataNoProducts.innerHTML = "Nenhum produto encontrado";

			productsTable.append(tableRow);
			tableRow.append(tableDataNoProducts);
		}
	}

	function adminEditProduct(productId) {
		if (typeof productId == 'undefined' || productId == null) {
			return;
		}

		$(".content").html(siteContent.admin.editarProduto);
		let tx = connection.transaction(databaseProductsName, "readwrite");
		let objectStore = tx.objectStore(databaseProductsName);
		let request = objectStore.index("id").get(productId);

		request.onsuccess = function(e) {
			let productInfo = e.target.result;
			if (typeof productInfo == 'undefined') {
				return;
			}

			$("#edit_product_name").val(productInfo.nome);
			$("#edit_product_description").val(productInfo.descricao);
			$("#edit_product_price").val(productInfo.preco);
			$("#edit_product_quantity").val(productInfo.quantidade);

			$("#edit_product_form").on('submit', function(e) {
				e.preventDefault();

				let name = $("#edit_product_name").val();
				let description = $("#edit_product_description").val();
				let price = $("#edit_product_price").val();
				let quantity = $("#edit_product_quantity").val();

				if (name.length == 0) {
					alert("Insira um nome para o produto");
					return;
				} else if (typeof price == 'undefined' || price == null || price.length == 0) {
					alert("Insira um preço");
					return;
				} else if (typeof quantity == 'undefined' || quantity == null || quantity.length == 0) {
					alert("Insira uma quantidade");
					return;
				}

				productInfo.nome = name;
				productInfo.descricao = description;
				productInfo.preco = price;
				productInfo.quantidade = quantity;

				let tx = connection.transaction(databaseProductsName, "readwrite");
				let objectStore = tx.objectStore(databaseProductsName);
				let request = objectStore.put(productInfo);

				request.onsuccess = function(e) {
					alert("Produto atualizado");
					adminShowProducts();
				};

				request.onerror = function(e) {
					alert("Erro ao editar produto, tente novamente")
				};
			});
		};

		request.onerror = function(e) {
			alert("Erro ao buscar produto");
			adminShowProducts();
		};
	}

	function adminDeleteProduct(productId) {
		if (typeof productId == 'undefined' || productId == null) {
			return;
		}

		if (window.confirm("Deseja deletar esse produto?")) {
			let tx = connection.transaction(databaseProductsName, "readwrite");
			let objectStore = tx.objectStore(databaseProductsName);
			let request = objectStore.delete(productId);
			request.onsuccess = function(e) {
				adminProducts = adminProducts.filter(function(product) {
					return product.id != productId;
				});
				adminBuildProductsTable();
			};

			request.onerror = function(e) {
				alert("Falha ao deletar produto")
			}
		}
	}

	// Client Functions
	function menuClick(component) {
		switch(component.attributes.tab.value) {
			case "gerenciarAnimais":
				showAnimalManager();
				break;
			case "agendarHorario":
				showScheduleService();
				break;
			case "comprarProduto":
				showBuyProduct();
				break;
			case "carrinho":
				showCart();
				break;
			case "editarRegistro":
				showEditUser();
				break;
		}		
	}

	function showScheduleService() {
		$(".content").html(siteContent.client.agendarHorario);
		getAllServiceTypes();
		var tx = connection.transaction(databasePetsName, "readonly");
		var objectStore = tx.objectStore(databasePetsName);
		var request = objectStore.index("dono").getAll(connectedUser.usuario);
		request.onsuccess = function(event) {
			let animalsData = event.target.result;
			if (typeof animalsData != 'undefined') {
				let animalsSelect = document.getElementById("select_animal");
				animalsData.forEach(function (animal) {
					let option = document.createElement('option');
					option.value = animal.id;
					option.text = animal.nome;
					animalsSelect.append(option);
				});
			}
		}

		var today = new Date();
		var dd = today.getDate();
		var mm = today.getMonth() + 1;
		var yyyy = today.getFullYear();
		if (dd < 10) {
	        dd = '0' + dd;
	    } 
	    if (mm < 10) {
	        mm = '0' + mm;
	    } 
		today = yyyy + '-' + mm + '-' + dd;
		document.getElementById("date_input").setAttribute("min", today);

		$("#agendar_horario_form").on('submit', function(e) {
			e.preventDefault();
			let serviceId = $("#select_service").val();
			let animalId = $("#select_animal").val();
			let date = $("#date_input").val();
			let time = $("#select_time").val();
			if (serviceId == null) {
				alert("Por favor escolha um serviço");
			} else if (animalId == null) {
				alert("Por favor cadastre um animal para poder agendar um serviço");
			} else if (date == null || date.length == 0) {
				alert("Por favor escolha uma data");
			} else if (time == null) {
				alert("Por favor escolha um horário");
			} else {
				let servicoAgendado = {
					servico: Number(serviceId),
					data: date,
					hora: time,
					animal: Number(animalId)
				};
				let tx = connection.transaction(databaseScheduledServicesName, "readwrite");
				let objectStore = tx.objectStore(databaseScheduledServicesName);
				let request = objectStore.put(servicoAgendado);

				request.onsuccess = function(e) {
					alert("Serviço agendado com sucesso");
				};

				request.onerror = function(e) {
					alert("Já existe outro serviço agendado nesta data");
				};
			}
		});
	}

	function getAllServiceTypes() {
		let tx = connection.transaction(databaseServiceTypesName, "readonly");
		let objectStore = tx.objectStore(databaseServiceTypesName);
		let request = objectStore.getAll();

		request.onsuccess = function(e) {
			let serviceTypes = e.target.result;
			if (typeof serviceTypes != 'undefined') {
				let serviceSelect = document.getElementById("select_service");
				while (serviceSelect.options.length) {
			        serviceSelect.remove(0);
			    }
				serviceTypes.forEach(function(serviceType) {
					let option = document.createElement('option');
					option.text = serviceType.nome + " (R$" + serviceType.preco + ")";
					option.value = serviceType.id;

					serviceSelect.append(option);
				});
			}
		}

		request.onerror = function(e) {
			console.log(e);
		}
	}

	function showBuyProduct() {
		$(".content").html(siteContent.client.comprarProduto);

		let tx = connection.transaction(databaseProductsName, "readonly");
		let objectStore = tx.objectStore(databaseProductsName);
		let request = objectStore.getAll();

		request.onsuccess = function(e) {
			let products = e.target.result;
			if (typeof products == 'undefined') {
				userProducts = [];
				return;
			}
			userProducts = products;
			buildBuyProductTable();

			$("#sort_by_select").change(function() {
				buildBuyProductTable();
			});

			$("#sort_order_select").change(function() {
				buildBuyProductTable();
			});
		}
	}

	function buildBuyProductTable() {
		let productsTable = document.getElementById("product_table");
		let sortBy = $("#sort_by_select").val();
		let sortPriority = $("#sort_order_select").val();

		let products = userProducts.sort(function(product1, product2) {
			switch (sortBy) {
				case "nome":
					return (sortPriority == "crescente") ? product1.nome > product2.nome : product1.nome < product2.nome;
					break;

				case "preco":
					return (sortPriority == "crescente") ? product1.preco > product2.preco : product1.preco < product2.preco;
					break;
			}
		});

		productsTable.innerHTML = "";
		if (products.length > 0) {
			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderProductName = document.createElement('th');
			tableHeaderProductName.innerHTML = "Produto";

			let tableHeaderProductDescription = document.createElement('th');
			tableHeaderProductDescription.innerHTML = "Descrição";

			let tableHeaderProductPrice = document.createElement('th');
			tableHeaderProductPrice.innerHTML = "Preço";

			productsTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderProductName);
			tableHeaderRow.append(tableHeaderProductDescription);
			tableHeaderRow.append(tableHeaderProductPrice);

			products.forEach(function(product) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataProductName = document.createElement('td');
				tableDataProductName.setAttribute('class', "service_table_data");
				tableDataProductName.innerHTML = product.nome;

				let tableDataProductDescription = document.createElement('td');
				tableDataProductDescription.setAttribute('class', "service_table_data");
				tableDataProductDescription.innerHTML = product.descricao;

				let tableDataProductPrice = document.createElement('td');
				tableDataProductPrice.setAttribute('class', "service_table_data");
				tableDataProductPrice.innerHTML = "R$ " + Number(product.preco).toFixed(2);

				let productDetailtA = document.createElement('a');
				productDetailtA.setAttribute('onclick','showProductInfo(' + product.id + ')');

				let productDetailImage = document.createElement('img');
				productDetailImage.src = "icons/clipboard.png";
				productDetailImage.width = 18;
				productDetailImage.height = 18;
				productDetailImage.style.paddingTop = "4px";
				productDetailImage.style.paddingRight = "4px";

				productsTable.append(tableRow);
				tableRow.append(tableDataProductName);
				tableRow.append(tableDataProductDescription);
				tableRow.append(tableDataProductPrice);
				tableRow.append(productDetailtA);
				productDetailtA.append(productDetailImage);
			});
		} else {
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoProducts = document.createElement('td');
			tableDataNoProducts.setAttribute('class', "service_table_data");
			tableDataNoProducts.innerHTML = "Nenhum produto encontrado";

			productsTable.append(tableRow);
			tableRow.append(tableDataNoProducts);
		}
	}

	function showProductInfo(productId) {
		if (typeof productId == 'undefined' || productId == null) {
			return;
		}

		$(".content").html(siteContent.client.detalhesProduto);
		let tx = connection.transaction(databaseProductsName, "readwrite");
		let objectStore = tx.objectStore(databaseProductsName);
		let request = objectStore.index("id").get(productId);

		request.onsuccess = function(e) {
			let productInfo = e.target.result;
			if (typeof productInfo == 'undefined') {
				return;
			}

			$("#product_name_header").html(productInfo.nome);
			$("#description_div").html(productInfo.descricao);
			let max = productInfo.quantidade;
			if (userCart[productInfo.id] != null) {
				max -= userCart[productInfo.id];
			}
			$("#product_quantity").attr({"min" : 0, "max" : max});
			$("#price_div").html("R$ " + productInfo.preco);
			$("#buy_button").html(productInfo.quantidade > 0 ? "Comprar" : "Indisponível");
			$("#buy_button").css("background-color", (productInfo.quantidade > 0) ? "#00b214" : "af0000");

			$("#buy_form").on('submit', function(e) {
				e.preventDefault();
				let quantity = Number($("#product_quantity").val());

				if (quantity > 0) {
					if (userCart[productId] == null) {
						userCart[productId] = quantity;
					} else {
						userCart[productId] += quantity;
					}
				}	

				showBuyProduct();
			});
		};

		request.onerror = function(e) {
			alert("Erro ao buscar produto");
			showBuyProduct();
		};
	}

	function showCart() {
		$(".content").html(siteContent.client.carrinho);

		let tx = connection.transaction(databaseProductsName, "readonly");
		let objectStore = tx.objectStore(databaseProductsName);
		let request = objectStore.getAll();

		request.onsuccess = function(e) {
			let products = e.target.result;
			if (typeof products == 'undefined') {
				alert("Falha ao recuperar o carrinho, por favor tente novamente");
				return;
			}

			userProducts = products;
			buildCartTable();

			$("#sort_by_select").change(function() {
				buildCartTable();
			});

			$("#sort_order_select").change(function() {
				buildCartTable();
			});

			$("#complete_buy").on('submit', function(e) {
				e.preventDefault();

				let buyPromises = [];
				for (let productId in userCart) {
					let quantity = userCart[productId];

					let promise = new Promise(function(resolve, reject) {
						let tx = connection.transaction(databaseProductsName, "readonly");
						let objectStore = tx.objectStore(databaseProductsName);
						let request = objectStore.index("id").get(Number(productId));

						request.onsuccess = function(e) {
							let productInfo = e.target.result;
							if (typeof productInfo != 'undefined') {
								productInfo.quantidade -= quantity;

								let tx = connection.transaction(databaseProductsName, "readwrite");
								let objectStore = tx.objectStore(databaseProductsName);
								let putRequest = objectStore.put(productInfo);

								putRequest.onsuccess = function(e) {
									resolve();
								};

								putRequest.onerror = function(e) {
									resolve();
								}
							} else {
								resolve();
							}
						};

						request.onerror = function(e) {
							resolve();
						};
					});
					buyPromises.push(promise);
				}
				Promise.all(buyPromises).then(function() {
					alert("Obrigado por finalizar a compra!");
					userCart = {};
					showCart();
				});
			});
		};

		request.onerror = function(e) {
			alert("Falha ao recuperar o carrinho, por favor tente novamente");
		};
	}

	function buildCartTable() {
		let productsTable = document.getElementById("cart_table");
		let sortBy = $("#sort_by_select").val();
		let sortPriority = $("#sort_order_select").val();

		let products = [];

		for (let productId in userCart) {
			let quantity = userCart[productId];
			let product = userProducts.find(function(product) {
				return product.id == productId;
			});
			if (typeof product == 'undefined') {
				return;
			}
			product.quantidade = quantity;
			products.push(product);
		}

		products = products.sort(function(product1, product2) {
			switch (sortBy) {
				case "nome":
					return (sortPriority == "crescente") ? product1.nome > product2.nome : product1.nome < product2.nome;
					break;

				case "quantidade":
					return (sortPriority == "crescente") ? product1.quantidade > product2.quantidade : product1.quantidade < product2.quantidade;
					break;

				case "preco":
					return (sortPriority == "crescente") ? product1.preco > product2.preco : product1.preco < product2.preco;
					break;

				case "precoTotal":
					let total1 = product1.preco * product1.quantidade;
					let total2 = product2.preco * product2.quantidade;
					return (sortPriority == "crescente") ? total1 > total2 : total1 < total2;
					break;
			}
		});

		productsTable.innerHTML = "";
		if (products.length > 0) {
			let totalPrice = 0.0;

			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderProductName = document.createElement('th');
			tableHeaderProductName.innerHTML = "Produto";

			let tableHeaderProductQuantity = document.createElement('th');
			tableHeaderProductQuantity.innerHTML = "Quantidade";

			let tableHeaderProductPrice = document.createElement('th');
			tableHeaderProductPrice.innerHTML = "Preço";

			let tableHeaderProductTotalPrice = document.createElement('th');
			tableHeaderProductTotalPrice.innerHTML = "Total";

			productsTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderProductName);
			tableHeaderRow.append(tableHeaderProductQuantity);
			tableHeaderRow.append(tableHeaderProductPrice);
			tableHeaderRow.append(tableHeaderProductTotalPrice);

			products.forEach(function(product) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataProductName = document.createElement('td');
				tableDataProductName.setAttribute('class', "service_table_data");
				tableDataProductName.innerHTML = product.nome;

				let tableDataProductQuantity = document.createElement('td');
				tableDataProductQuantity.setAttribute('class', "service_table_data");
				tableDataProductQuantity.innerHTML = product.quantidade;

				let tableDataProductPrice = document.createElement('td');
				tableDataProductPrice.setAttribute('class', "service_table_data");
				tableDataProductPrice.innerHTML = "R$ " + Number(product.preco).toFixed(2);

				let tableDataProductTotalPrice = document.createElement('td');
				tableDataProductTotalPrice.setAttribute('class', "service_table_data");
				tableDataProductTotalPrice.innerHTML = "R$ " + Number(product.preco * Number(product.quantidade)).toFixed(2);
				totalPrice += product.preco * Number(product.quantidade);

				let productRemoveA = document.createElement('a');
				productRemoveA.setAttribute('onclick','removeProductFromCart(' + product.id + ')');

				let productRemoveImage = document.createElement('img');
				productRemoveImage.src = "icons/delete.png";
				productRemoveImage.width = 18;
				productRemoveImage.height = 18;
				productRemoveImage.style.paddingTop = "4px";
				productRemoveImage.style.paddingRight = "4px";

				productsTable.append(tableRow);
				tableRow.append(tableDataProductName);
				tableRow.append(tableDataProductQuantity);
				tableRow.append(tableDataProductPrice);
				tableRow.append(tableDataProductTotalPrice);
				tableRow.append(productRemoveA);
				productRemoveA.append(productRemoveImage);
			});
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataTotal = document.createElement('td');
			tableDataTotal.setAttribute('class', "service_table_data");
			tableDataTotal.innerHTML = "Total";

			let tableDataTotalPrice = document.createElement('td');
			tableDataTotalPrice.setAttribute('class', "service_table_data");
			tableDataTotalPrice.innerHTML = "R$" + totalPrice;

			productsTable.append(tableRow);
			productsTable.append(tableDataTotal);
			productsTable.append(tableDataTotalPrice);
		} else {
			$("#complete_buy").css('display', 'none');

			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoProducts = document.createElement('td');
			tableDataNoProducts.setAttribute('class', "service_table_data");
			tableDataNoProducts.innerHTML = "Carrinho vazio";

			productsTable.append(tableRow);
			tableRow.append(tableDataNoProducts);
		}
	}

	function removeProductFromCart(productId) {
		if (window.confirm("Deseja remover o produto do carrinho?")) {
			delete userCart[productId];
			buildCartTable();
		}
	}

	function showEditUser() {
		$(".content").html(siteContent.client.editarRegistro);
		var tx = connection.transaction(databaseUsersName, "readonly");
		var objectStore = tx.objectStore(databaseUsersName);
		var request = objectStore.index("usuario").get(connectedUser.usuario);
    	request.onsuccess = function(event) {
    		let userInfo = event.target.result;
		    if (typeof userInfo != 'undefined') {
		    	$("#register_name").val(userInfo.nome);
				$("#register_address_phone").val(userInfo.telefone);
				$("#register_address_email").val(userInfo.email);
				$("#register_address_city").val(userInfo.cidade);
				$("#register_address_neighborhood").val(userInfo.bairro);
				$("#register_address_street").val(userInfo.rua);
				$("#editar_registro_form").on('submit', function(e){
					e.preventDefault();
					let nome = $("#register_name").val();
					let telefone = $("#register_address_phone").val();
					let email = $("#register_address_email").val();
					let cidade = $("#register_address_city").val();
					let bairro = $("#register_address_neighborhood").val();
					let rua = $("#register_address_street").val();
					let senha = $("#register_password").val();
					let repetirSenha = $("#register_repeat_password").val();

					if (nome.length == 0) {
						alert("Por favor insira um nome");
						return;
					} else if (telefone.length == 0) {
						alert("Por favor insira um telefone");
						return;
					} else if (email.length == 0) {
						alert("Por favor insira um email");
						return;
					}

					if (senha.length > 0 && senha != repetirSenha) {
						alert("As senhas estão diferentes.");
						return;
					}

					userInfo.nome = nome;
					userInfo.telefone = telefone;
					userInfo.email = email;
					userInfo.cidade = cidade;
					userInfo.bairro = bairro;
					userInfo.rua = rua;
					if (senha.length > 0) {
						userInfo.senha = senha;
					}

					let request = connection.transaction(databaseUsersName, "readwrite").objectStore(databaseUsersName).put(userInfo);
					request.onsuccess = function(e){
			            alert("Cadastro atualizado!");
			            setWelcomeMessageName(userInfo.nome);
			            connectedUser = userInfo;
			        };

			        request.onerror = function(e){
			            alert("Erro ao atualizar cadastro, tente novamente.");
			        };
				});
		    } else {
		    	alert("Erro ao recuperar informações do usuário, por favor tente novamente.");
		    }
		};
	}

	function showAnimalManager() {
		$(".content").html(siteContent.client.gerenciarAnimais);
		getAllUserAnimals();
		hideAnimalRegisterForm();
		$('#register_animal_input').click(function(e){
			e.preventDefault();
			didTapRegisterAnimal();
		});
	}

	function getAllUserAnimals() {
		var tx = connection.transaction(databasePetsName, "readonly");
		var objectStore = tx.objectStore(databasePetsName);
		var request = objectStore.index("dono").getAll(connectedUser.usuario);
		request.onsuccess = function(event) {
			let animalsData = event.target.result;
			if (typeof animalsData != 'undefined') {
				let form = document.getElementById("gerenciar_animais_form");
				let oldAnimalsList = document.getElementById("gerenciar_animais_list");
				oldAnimalsList.remove();
				let animalsList = document.createElement('div');
				animalsList.id = "gerenciar_animais_list";
				form.append(animalsList);
				animalsData.forEach(function (animal) {
					let listedAnimalContainerDiv = document.createElement('div');
					listedAnimalContainerDiv.setAttribute('class', "listed_animal_container");

					let animalInfoContainerDiv = document.createElement('div');
					animalInfoContainerDiv.setAttribute('class', "animal_info_container");

					let animalNameSpan = document.createElement('span');
					animalNameSpan.innerHTML = animal.nome;

					let iconsContainerDiv = document.createElement('div');
					iconsContainerDiv.setAttribute('class', "icons_container");

					let animalDetailsA = document.createElement('a');
					animalDetailsA.setAttribute('onclick','animalDetailsClick(' + animal.id + ');');

					let animalDetailImage = document.createElement('img');
					animalDetailImage.src = "icons/clipboard.png";

					let animalDeleteA = document.createElement('a');
					animalDeleteA.setAttribute('onclick','deleteAnimalClick("' + animal.nome + '", ' + animal.id + ');');

					let animalDeleteImage = document.createElement('img');
					animalDeleteImage.src = "icons/delete.png";

					animalsList.append(listedAnimalContainerDiv);
					listedAnimalContainerDiv.append(animalInfoContainerDiv);
					animalInfoContainerDiv.append(animalNameSpan);
					listedAnimalContainerDiv.append(iconsContainerDiv);
					iconsContainerDiv.append(animalDetailsA);
					animalDetailsA.append(animalDetailImage);
					iconsContainerDiv.append(animalDeleteA);
					animalDeleteA.append(animalDeleteImage);
				});
			}
		};
	}

	function animalDetailsClick(animalId) {
		let servicesPromise = new Promise(function(resolve, reject) {
			let servicesTx = connection.transaction(databaseServiceTypesName, "readonly");
			let servicesObjectStore = servicesTx.objectStore(databaseServiceTypesName);
			let servicesRequest = servicesObjectStore.getAll();

			servicesRequest.onsuccess = function(e) {
				let services = e.target.result;
				if (typeof services != 'undefined') {
					resolve(services);
				} else {
					resolve([]);
				}
			}
		});

		servicesPromise.then(function(services) {
			let animalTx = connection.transaction(databasePetsName, "readwrite");
			let animalObjectStore = animalTx.objectStore(databasePetsName);
			let animalRequest = animalObjectStore.index("id").get(animalId);
			animalRequest.onsuccess = function(e) {
				let animalInfo = e.target.result;
				if (typeof animalInfo != 'undefined') {
					$(".content").html(siteContent.client.visualizarAnimal);
					document.getElementById("animal_name_title").innerText = animalInfo.nome;
					document.getElementById("animal_race_title").innerText = animalInfo.especie;
				}
			};

			let scheduledServicesTx = connection.transaction(databaseScheduledServicesName, "readwrite");
			let scheduledServicesObjectStore = scheduledServicesTx.objectStore(databaseScheduledServicesName);
			let scheduledServicesRequest = scheduledServicesObjectStore.index("animal").getAll(animalId);
			scheduledServicesRequest.onsuccess = function(e) {
				let scheduledServices = e.target.result;
				let servicesTable = document.getElementById("service_table");
				if (typeof scheduledServices != 'undefined' && scheduledServices.length > 0) {
					let totalPrice = 0.0;
					scheduledServices.forEach(function (scheduledService) {
						let service = services.find(function(service) {
							return service.id == scheduledService.servico;
						});
						if (typeof service == 'undefined') {
							return;
						}
						let tableRow = document.createElement('tr');
						tableRow.setAttribute('class', "service_table_row");

						let tableDataServiceName = document.createElement('td');
						tableDataServiceName.setAttribute('class', "service_table_data");
						tableDataServiceName.innerHTML = service.nome;

						let tableDataServiceDate = document.createElement('td');
						tableDataServiceDate.setAttribute('class', "service_table_data");
						tableDataServiceDate.innerHTML = scheduledService.data;

						let tableDataServiceTime = document.createElement('td');
						tableDataServiceTime.setAttribute('class', "service_table_data");
						tableDataServiceTime.innerHTML = scheduledService.hora;

						let tableDataServicePrice = document.createElement('td');
						tableDataServicePrice.setAttribute('class', "service_table_data");
						tableDataServicePrice.innerHTML = "R$" + service.preco;
						totalPrice += service.preco;

						servicesTable.append(tableRow);
						servicesTable.append(tableDataServiceName);
						servicesTable.append(tableDataServiceDate);
						servicesTable.append(tableDataServiceTime);
						servicesTable.append(tableDataServicePrice);
					});
					let tableRow = document.createElement('tr');
					tableRow.setAttribute('class', "service_table_row");

					let tableDataTotal = document.createElement('td');
					tableDataTotal.setAttribute('class', "service_table_data");
					tableDataTotal.innerHTML = "Total";

					let tableDataTotalPrice = document.createElement('td');
					tableDataTotalPrice.setAttribute('class', "service_table_data");
					tableDataTotalPrice.innerHTML = "R$" + totalPrice;

					servicesTable.append(tableRow);
					servicesTable.append(tableDataTotal);
					servicesTable.append(tableDataTotalPrice);
				} else {
					let tableRow = document.createElement('tr');
					tableRow.setAttribute('class', "service_table_row");

					let tableDataTotal = document.createElement('td');
					tableDataTotal.setAttribute('class', "service_table_data");
					tableDataTotal.innerHTML = "Nenhum serviço";

					servicesTable.append(tableRow);
					servicesTable.append(tableDataTotal);
				}
			};
		});
	}

	function deleteAnimalClick(animalName, animalId) {
		if(window.confirm("Deseja remover " + animalName + "?")) {
			let tx = connection.transaction(databasePetsName, "readwrite");
			let objectStore = tx.objectStore(databasePetsName);
			let request = objectStore.delete(animalId);
			request.onsuccess = function(e) {
				getAllUserAnimals();
				let scheduledServicesTx = connection.transaction(databaseScheduledServicesName, "readwrite");
				let scheduledServicesObjectStore = scheduledServicesTx.objectStore(databaseScheduledServicesName);
				let request = scheduledServicesObjectStore.index("animal").openCursor();

				request.onsuccess = function(e) {
					let cursor = e.target.result;
					if (cursor) {
						let scheduledService = cursor.value;
						if (typeof scheduledService != 'undefined' && scheduledService.animal == animalId) {
							scheduledServicesObjectStore.delete(scheduledService.id);
						}
						cursor.continue();
					}
				}
			};
		}
	}

	function showAnimalRegisterForm() {
		document.getElementById("animal_register_form").style.display = "initial";
		document.getElementById("animal_name_field").value = "";
		document.getElementById("animal_race_field").value = "";
	}

	function didTapRegisterAnimal() {
		let name = document.getElementById("animal_name_field").value;
		let race = document.getElementById("animal_race_field").value;

		if (name.length > 0 && race.length > 0) {
			animal = {
				nome: name,
				especie: race,
				dono: connectedUser.usuario
			};
			let tx = connection.transaction(databasePetsName, "readwrite");
			let objectStore = tx.objectStore(databasePetsName);
			let request = objectStore.put(animal);
			request.onsuccess = function(event) {
				hideAnimalRegisterForm();
				getAllUserAnimals();
				alert("Animal registrado com sucesso");
			};

			request.onerror = function(event) {
				alert("Falha ao salvar animal, por favor tente novamente.")
			};
		} else if (name.length == 0 && race.length == 0) {
			hideAnimalRegisterForm();
		} else if (name.length == 0) {
			alert("Por favor digite um nome.");
		} else if (race.length == 0) {
			alert("Por favor digite uma raça.");
		} else {
			hideAnimalRegisterForm();
		}
	}

	function hideAnimalRegisterForm() {
		document.getElementById("animal_register_form").style.display = "none";
	}
 	</script>
	
	<footer>
		Copyright
		Icons by Freepik of flaticon.com and Alfredo Hernandez of alfredocreates.com
	</footer>
</body>
</html>