<!DOCTYPE html>

<html lang="pt-br">
<head>
	<link rel="stylesheet" type="text/css" href="style.css"> 
	<link rel="stylesheet" type="text/css" href="titles.css"> 
	<link rel="stylesheet" type="text/css" href="menus.css"> 
	<link rel="stylesheet" type="text/css" href="forms.css"> 
	<link rel="stylesheet" type="text/css" href="animal_details.css">

	<meta charset="utf-8">

	<title>Pet Shop</title>
</head>
<body>
	<header>
		<h1 class="site_title">Pet Shop</h1>
	</header>

	<nav>
		<ul class="horizontal_menu">
		</ul>
	</nav>
	<main class="content">

	</main>
 	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="site_content.js"></script>

 	<script>
	var connection;
	var connectedUser;

	// Admin Variables
	let adminScheduledServices = [];
	let adminProducts = [];

	// User Variables
	let userCart = {};
	let userProducts =[];

	$(document).ready(
		function() {
			$(".horizontal_menu").html(horizontalMenu.index)
			$(".content").html(siteContent.index);
			$('#login_form').submit(function(e) {
				e.preventDefault();
				loginClick();
			});
		}
	);

	function getImageSrcFromImageData(imageData, callback) {
		var png = imageData.split(',')[1];
	    var binary = window.atob(png);
	    
	    var blob = new Blob([binary],  {type: 'image/png'});
	    
	    var fr = new FileReader();
	    fr.onload = function ( oFREvent ) {
	        callback("data:image/png;base64," + btoa(oFREvent.target.result));
	    };
	    fr.readAsText(blob, "utf-8");
	}

	function loginClick() {
		const usernameValue = document.getElementById("login_username").value;
		const passwordValue = document.getElementById("login_password").value;
		const data = JSON.stringify({user: usernameValue, password: passwordValue});
		$.ajax({
	        type: 'post',
	        contentType: 'application/json',
	        url: 'login',
	        data: data,
	        success: function(response) {
	       		connectedUser = response.data;
	       		if (connectedUser.isAdmin) {
					$(".horizontal_menu").html(horizontalMenu.admin);
					adminShowRegisterArea();
				} else {
					$(".horizontal_menu").html(horizontalMenu.client);
					showAnimalManager();
				}
				setWelcomeMessageName(connectedUser.name);
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function logoutClick() {
		connectedUser = null;
		adminScheduledServices = [];
		adminProducts = [];

		userCart = {};
		userProducts =[];
		$("#user_login_box").remove();
		$(".content").html(siteContent.index);
		$(".horizontal_menu").html(horizontalMenu.index);
		$('#login_form').on('submit', function(e){
			e.preventDefault();
			loginClick();
		});
	}

	function setWelcomeMessageName(name) {
		$("#user_login_box").remove();
		$("header").append(siteContent.logoutBox);
		$("#welcome_span").html($("#welcome_span").html().replace("user_name", name));
		$('#logout').click(function(e){
			e.preventDefault();
			logoutClick();
		});
	}

	// Admin Functions
	function adminMenuClick(component) {
		switch(component.attributes.tab.value) {
			case "novosCadastros":
				adminShowRegisterArea();
				break;
			case "servicosAgendados":
				adminShowScheduledServices();
				break;
			case "controleDeEstoque":
				adminShowProducts();
				break;
		}
	}

	function adminShowRegisterArea() {
		$(".content").html(siteContent.admin.novosCadastros);
		document.getElementById("new_user_form").style.display = "none";
		document.getElementById("new_product_form").style.display = "none";
		document.getElementById("new_service_form").style.display = "none";

		$("#new_user_button").click(function(e) {
			e.preventDefault();
			document.getElementById("new_user_form").style.display = "initial";
			document.getElementById("new_product_form").style.display = "none";
			document.getElementById("new_service_form").style.display = "none";

			document.getElementById("register_username").value = "";
			document.getElementById("register_name").value = "";
			document.getElementById("register_address_phone").value = "";
			document.getElementById("register_address_email").value = "";
			document.getElementById("register_address_city").value = "";
			document.getElementById("register_address_neighborhood").value = "";
			document.getElementById("register_address_street").value = "";
			document.getElementById("register_password").value = "";
			document.getElementById("register_repeat_password").value = "";
		});
		$("#new_product_button").click(function(e) {
			e.preventDefault();
			document.getElementById("new_user_form").style.display = "none";
			document.getElementById("new_product_form").style.display = "initial";
			document.getElementById("new_service_form").style.display = "none";

			document.getElementById("register_product_name").value = "";
			document.getElementById("register_product_description").value = "";
		});
		$("#new_service_button").click(function(e) {
			e.preventDefault();
			document.getElementById("new_user_form").style.display = "none";
			document.getElementById("new_product_form").style.display = "none";
			document.getElementById("new_service_form").style.display = "initial";

			document.getElementById("register_service_name").value = "";
			document.getElementById("register_service_price").value = "";
		});

		$("#new_user_form").on('submit', function(e) {
			e.preventDefault();

			let username = document.getElementById("register_username").value;
			let name = document.getElementById("register_name").value;
			let phone = document.getElementById("register_address_phone").value;
			let email = document.getElementById("register_address_email").value;
			let city = document.getElementById("register_address_city").value;
			let neighborhood = document.getElementById("register_address_neighborhood").value;
			let street = document.getElementById("register_address_street").value;
			let password = document.getElementById("register_password").value;
			let repeatPassword = document.getElementById("register_repeat_password").value;
			let isAdmin = document.getElementById("register_is_admin").checked;

			if (username.length == 0) {
				alert("Por favor insira um nome de usuário");
			} else if (name.length == 0) {
				alert("Por favor insira um nome");
			} else if (phone.length == 0) {
				alert("Por favor insira um telefone");
			} else if (email.length == 0) {
				alert("Por favor insira um email");
			} else if (password.length == 0) {
				alert("Por favor insira uma senha");
			} else if (password != repeatPassword) {
				alert("As senhas inseridas são diferentes");
			} else {
				let user = {
					user: username.toLowerCase(),
					name: name,
					password: password,
					repeatPassword: repeatPassword,
					email: email,
					phone: phone,
					city: city,
					street: street,
					neighborhood: neighborhood,
					isAdmin: isAdmin
				};
				const data = JSON.stringify(user);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: 'users',
			        data: data,
			        success: function(response) {
						alert(response.message);
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});

		$("#new_product_form").on('submit', function(e) {
			e.preventDefault();

			let name = $("#register_product_name").val();
			let description = $("#register_product_description").val();
			let price = $("#register_product_price").val();
			let quantity = $("#register_product_quantity").val();

			if (name.length == 0) {
				alert("Insira um nome para o produto");
			} else if (typeof price == 'undefined' || price == null || price.length == 0) {
				alert("Insira um preço");
			} else if (typeof quantity == 'undefined' || quantity == null || quantity.length == 0) {
				alert("Insira uma quantidade");
			} else {
				let productInfo = {
					name: name,
					description: description,
					price: Number(price),
					quantity: Number(quantity)
				};
				const data = JSON.stringify(productInfo);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: 'products',
			        data: data,
			        success: function(response) {
						alert(response.message);
						$("#new_product_name").val("");
						$("#new_product_description").val("");
						$("#new_product_price").val("");
						$("#new_product_quantity").val("");
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});

		$("#new_service_form").on('submit', function(e) {
			e.preventDefault();
			let name = document.getElementById("register_service_name").value;
			let price = document.getElementById("register_service_price").value;

			if (name.length == 0) {
				alert("Por favor insira um nome")
			} else if (price.length == 0) {
				alert("Por favor insira um preço")
			} else {
				let serviceTypeInfo = {
					name: name,
					price: Number(price)
				};
				const data = JSON.stringify(serviceTypeInfo);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: 'service_types',
			        data: data,
			        success: function(response) {
						alert(response.message);
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});
	}

	function adminShowScheduledServices() {
		$(".content").html(siteContent.admin.servicosAgendados);

		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: 'scheduled_services',
	        success: function(response) {
	        	adminScheduledServices = response.data;
	        	let serviceTypes = {};
				let animals = {};
	        	let animalOwners = {};
				adminScheduledServices.forEach(function(scheduledService) {
					serviceTypes[scheduledService.serviceType.id] = scheduledService.serviceType.name;
					animals[scheduledService.animal.id] = scheduledService.animal.name;
					animalOwners[scheduledService.animalOwner.user] = scheduledService.animalOwner.name;
				});

				serviceTypes = Object.keys(serviceTypes).map(function(serviceTypeId) {
					return {name: serviceTypes[serviceTypeId], id: serviceTypeId};
				}).sort(function(serviceType1, serviceType2) {
					return serviceType1.name > serviceType2.name;
				});

				animals = Object.keys(animals).map(function(animalId) {
					return {name: animals[animalId], id: animalId};
				}).sort(function(animal1, animal2) {
					return animal1.name > animal2.name;
				});

				animalOwners = Object.keys(animalOwners).map(function(user) {
					return {name: animalOwners[user], user: user};
				}).sort(function(user1, user2) {
					return user1.name > user2.name;
				});

				let serviceTypeSelect = document.getElementById("service_type_select");
				serviceTypes.forEach(function(serviceType) {
					let option = document.createElement('option');
					option.value = serviceType.id;
					option.text = serviceType.name;

					serviceTypeSelect.append(option);
				});

				let animalSelect = document.getElementById("animal_select");
				animals.forEach(function(animal) {
					let option = document.createElement('option');
					option.value = animal.id;
					option.text = animal.name;

					animalSelect.append(option);
				});

				let usersSelect = document.getElementById("user_select");
				animalOwners.forEach(function(user) {
					let option = document.createElement('option');
					option.value = user.user;
					option.text = user.name;

					usersSelect.append(option);
				});

				adminBuildScheduledServiceTable();

				$("#user_select").change(function() {
					adminBuildScheduledServiceTable();
				});

				$("#service_type_select").change(function() {
					adminBuildScheduledServiceTable();
				});

				$("#animal_select").change(function() {
					adminBuildScheduledServiceTable();
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function adminBuildScheduledServiceTable() {
		let user = $("#user_select").val();
		let serviceTypeId = $("#service_type_select").val();
		let animalId = $("#animal_select").val();
		let scheduledServicesAux = adminScheduledServices;
		if (serviceTypeId != null && serviceTypeId.length > 0) {
			scheduledServicesAux = scheduledServicesAux.filter(function(scheduledService) {
				return scheduledService.serviceType.id == serviceTypeId;
			});
		}
		if (animalId != null && animalId.length > 0) {
			scheduledServicesAux = scheduledServicesAux.filter(function(scheduledService) {
				return scheduledService.animal.id == animalId;
			});
		}
		if (user != null && user.length > 0) {
			scheduledServicesAux = scheduledServicesAux.filter(function(scheduledService) {
				return scheduledService.animalOwner.user == user;
			});
		}

		let servicesTable = document.getElementById("service_table");
		servicesTable.innerHTML = "";
		if (scheduledServicesAux.length > 0) {
			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderAnimalName = document.createElement('th');
			tableHeaderAnimalName.innerHTML = "Animal";

			let tableHeaderAnimalDono = document.createElement('th');
			tableHeaderAnimalDono.innerHTML = "Dono";

			let tableHeaderServiceName = document.createElement('th');
			tableHeaderServiceName.innerHTML = "Serviço";

			let tableHeaderServiceDate = document.createElement('th');
			tableHeaderServiceDate.innerHTML = "Dia";

			let tableHeaderServiceTime = document.createElement('th');
			tableHeaderServiceTime.innerHTML = "Hora";

			servicesTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderAnimalName);
			tableHeaderRow.append(tableHeaderAnimalDono);
			tableHeaderRow.append(tableHeaderServiceName);
			tableHeaderRow.append(tableHeaderServiceDate);
			tableHeaderRow.append(tableHeaderServiceTime);

			scheduledServicesAux.forEach(function (scheduledService) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataAnimalName = document.createElement('td');
				tableDataAnimalName.setAttribute('class', "service_table_data");
				tableDataAnimalName.innerHTML = scheduledService.animal.name;

				let tableDataAnimalDono = document.createElement('td');
				tableDataAnimalDono.setAttribute('class', "service_table_data");
				tableDataAnimalDono.innerHTML = scheduledService.animalOwner.name;

				let tableDataServiceName = document.createElement('td');
				tableDataServiceName.setAttribute('class', "service_table_data");
				tableDataServiceName.innerHTML = scheduledService.serviceType.name;

				let tableDataServiceDate = document.createElement('td');
				tableDataServiceDate.setAttribute('class', "service_table_data");
				tableDataServiceDate.innerHTML = scheduledService.date;

				let tableDataServiceTime = document.createElement('td');
				tableDataServiceTime.setAttribute('class', "service_table_data");
				tableDataServiceTime.innerHTML = scheduledService.time;

				let serviceA = document.createElement('a');
				serviceA.setAttribute('onclick','adminDeleteScheduledService("' + scheduledService.id + '")');

				let serviceDeleteImage = document.createElement('img');
				serviceDeleteImage.src = "icons/delete.png";
				serviceDeleteImage.width = 18;
				serviceDeleteImage.height = 18;
				serviceDeleteImage.style.paddingTop = "4px";

				servicesTable.append(tableRow);
				tableRow.append(tableDataAnimalName);
				tableRow.append(tableDataAnimalDono);
				tableRow.append(tableDataServiceName);
				tableRow.append(tableDataServiceDate);
				tableRow.append(tableDataServiceTime);
				tableRow.append(serviceA);
				serviceA.append(serviceDeleteImage);
			});
		} else {
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoService = document.createElement('td');
			tableDataNoService.innerHTML = "Nenhum serviço encontrado";

			servicesTable.append(tableRow);
			servicesTable.append(tableDataNoService);
		}
	}

	function adminDeleteScheduledService(scheduledServiceId) {
		if (typeof scheduledServiceId == 'undefined' || scheduledServiceId == null) {
			return;
		}

		if (window.confirm("Deseja deletar esse agendamento?")) {
			$.ajax({
		        type: 'delete',
		        contentType: 'application/json',
		        url: "/scheduled_services/" + scheduledServiceId,
		        success: function(response) {
		        	adminScheduledServices = adminScheduledServices.filter(function(scheduledService) {
						return scheduledService.id != scheduledServiceId;
					});
					adminBuildScheduledServiceTable();
		        },
		        error: function(response) {
		        	alert(response.responseJSON.message);
		        }
	        });
		}
	}

	function adminShowProducts() {
		$(".content").html(siteContent.admin.controleDeEstoque);
		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: 'products',
	        success: function(response) {
	        	let products = response.data;
				if (typeof products == 'undefined') {
					adminProducts = [];
					return;
				}
				adminProducts = products;
				adminBuildProductsTable();

				$("#sort_by_select").change(function() {
					adminBuildProductsTable();
				});

				$("#sort_order_select").change(function() {
					adminBuildProductsTable();
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function adminBuildProductsTable() {
		let productsTable = document.getElementById("product_table");
		let sortBy = $("#sort_by_select").val();
		let sortPriority = $("#sort_order_select").val();

		let products = adminProducts.sort(function(product1, product2) {
			switch (sortBy) {
				case "nome":
					return (sortPriority == "crescente") ? product1.name > product2.name : product1.name < product2.name;
					break;

				case "preco":
					return (sortPriority == "crescente") ? product1.price > product2.price : product1.price < product2.price;
					break;

				case "quantidade":
					return (sortPriority == "crescente") ? product1.quantity > product2.quantity : product1.quantity < product2.quantity;
					break;
			}
		});

		productsTable.innerHTML = "";
		if (products.length > 0) {
			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderProductName = document.createElement('th');
			tableHeaderProductName.innerHTML = "Produto";

			let tableHeaderProductPrice = document.createElement('th');
			tableHeaderProductPrice.innerHTML = "Preço";

			let tableHeaderProductQuantity = document.createElement('th');
			tableHeaderProductQuantity.innerHTML = "Quantidade";

			productsTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderProductName);
			tableHeaderRow.append(tableHeaderProductPrice);
			tableHeaderRow.append(tableHeaderProductQuantity);

			products.forEach(function(product) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataProductName = document.createElement('td');
				tableDataProductName.setAttribute('class', "service_table_data");
				tableDataProductName.innerHTML = product.name;

				let tableDataProductPrice = document.createElement('td');
				tableDataProductPrice.setAttribute('class', "service_table_data");
				tableDataProductPrice.innerHTML = "R$ " + Number(product.price).toFixed(2);

				let tableDataProductQuantity = document.createElement('td');
				tableDataProductQuantity.setAttribute('class', "service_table_data");
				tableDataProductQuantity.innerHTML = product.quantity;

				let productEditA = document.createElement('a');
				productEditA.setAttribute('onclick','adminEditProduct("' + product.id + '")');

				let productEditImage = document.createElement('img');
				productEditImage.src = "icons/edit.png";
				productEditImage.width = 18;
				productEditImage.height = 18;
				productEditImage.style.paddingTop = "4px";
				productEditImage.style.paddingRight = "4px";

				let productDeleteA = document.createElement('a');
				productDeleteA.setAttribute('onclick','adminDeleteProduct("' + product.id + '")');

				let productDeleteImage = document.createElement('img');
				productDeleteImage.src = "icons/delete.png";
				productDeleteImage.width = 18;
				productDeleteImage.height = 18;
				productDeleteImage.style.paddingTop = "4px";

				productsTable.append(tableRow);
				tableRow.append(tableDataProductName);
				tableRow.append(tableDataProductPrice);
				tableRow.append(tableDataProductQuantity);
				tableRow.append(productEditA);
				productEditA.append(productEditImage);
				tableRow.append(productDeleteA);
				productDeleteA.append(productDeleteImage);
			});
		} else {
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoProducts = document.createElement('td');
			tableDataNoProducts.setAttribute('class', "service_table_data");
			tableDataNoProducts.innerHTML = "Nenhum produto encontrado";

			productsTable.append(tableRow);
			tableRow.append(tableDataNoProducts);
		}
	}

	function adminEditProduct(productId) {
		if (typeof productId == 'undefined' || productId == null) {
			return;
		}

		$(".content").html(siteContent.admin.editarProduto);

		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: "products/" + productId,
	        success: function(response) {
	        	let productInfo = response.data;
				if (typeof productInfo == 'undefined') {
					return;
				}

				$("#edit_product_name").val(productInfo.name);
				$("#edit_product_description").val(productInfo.description);
				$("#edit_product_price").val(productInfo.price);
				$("#edit_product_quantity").val(productInfo.quantity);

				$("#edit_product_form").on('submit', function(e) {
					e.preventDefault();

					const name = $("#edit_product_name").val();
					const description = $("#edit_product_description").val();
					const price = $("#edit_product_price").val();
					const quantity = $("#edit_product_quantity").val();

					if (name.length == 0) {
						alert("Insira um nome para o produto");
						return;
					} else if (typeof price == 'undefined' || price == null || price.length == 0) {
						alert("Insira um preço");
						return;
					} else if (typeof quantity == 'undefined' || quantity == null || quantity.length == 0) {
						alert("Insira uma quantidade");
						return;
					}

					const product = {
						name: name,
						description: description,
						price: Number(price),
						quantity: Number(quantity)
					}
					const data = JSON.stringify(product);
					$.ajax({
				        type: 'post',
				        contentType: 'application/json',
				        url: "products/" + productId,
				        data: data,
				        success: function(response) {
				        	alert(response.message);
				        	adminShowProducts();
				        }, error: function(response) {
				        	alert(response.responseJSON.message);
				        }
				    });
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        	adminShowProducts();
	        }
        });
	}

	function adminDeleteProduct(productId) {
		if (typeof productId == 'undefined' || productId == null) {
			return;
		}

		if (window.confirm("Deseja deletar esse produto?")) {
			$.ajax({
		        type: 'delete',
		        contentType: 'application/json',
		        url: "products/" + productId,
		        success: function(response) {
		        	adminProducts = adminProducts.filter(function(product) {
						return product.id != productId;
					});
		        	adminBuildProductsTable();
		        }, error: function(response) {
		        	alert(response.responseJSON.message);
		        }
		    });
		}
	}

	// Client Functions
	function menuClick(component) {
		switch(component.attributes.tab.value) {
			case "gerenciarAnimais":
				showAnimalManager();
				break;
			case "agendarHorario":
				showScheduleService();
				break;
			case "comprarProduto":
				showBuyProduct();
				break;
			case "carrinho":
				showCart();
				break;
			case "editarRegistro":
				showEditUser();
				break;
		}		
	}

	function showScheduleService() {
		$(".content").html(siteContent.client.agendarHorario);
		
		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: '/service_types',
	        success: function(response) {
	        	let serviceTypes = response.data;
				let serviceSelect = document.getElementById("select_service");
				while (serviceSelect.options.length) {
			        serviceSelect.remove(0);
			    }
				serviceTypes.forEach(function(serviceType) {
					let option = document.createElement('option');
					option.text = serviceType.name + " (R$" + serviceType.price + ")";
					option.value = serviceType.id;

					serviceSelect.append(option);
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });

        $.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: "/users/" + connectedUser.user + "/animals",
	        success: function(response) {
	        	let animals = response.data;
				let animalsSelect = document.getElementById("select_animal");
				animals.forEach(function (animal) {
					let option = document.createElement('option');
					option.value = animal.id;
					option.text = animal.name;
					animalsSelect.append(option);
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });

		var today = new Date();
		var dd = today.getDate();
		var mm = today.getMonth() + 1;
		var yyyy = today.getFullYear();
		if (dd < 10) {
	        dd = '0' + dd;
	    } 
	    if (mm < 10) {
	        mm = '0' + mm;
	    } 
		today = yyyy + '-' + mm + '-' + dd;
		document.getElementById("date_input").setAttribute("min", today);

		$("#agendar_horario_form").on('submit', function(e) {
			e.preventDefault();

			let serviceId = $("#select_service").val();
			let animalId = $("#select_animal").val();
			let date = $("#date_input").val();
			let time = $("#select_time").val();
			if (serviceId == null) {
				alert("Por favor escolha um serviço");
			} else if (animalId == null) {
				alert("Por favor cadastre um animal para poder agendar um serviço");
			} else if (date == null || date.length == 0) {
				alert("Por favor escolha uma data");
			} else if (time == null) {
				alert("Por favor escolha um horário");
			} else {
				const scheduledService = {
					serviceTypeId: serviceId,
					date: date,
					time: time,
					animalId: animalId
				};
				const data = JSON.stringify(scheduledService);
				$.ajax({
			        type: 'post',
			        contentType: 'application/json',
			        url: '/scheduled_services/',
			        data: data,
			        success: function(response) {
			        	alert(response.message);
			        },
			        error: function(response) {
			        	alert(response.responseJSON.message);
			        }
		        });
			}
		});
	}

	function showBuyProduct() {
		$(".content").html(siteContent.client.comprarProduto);

		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: '/products/',
	        success: function(response) {
				userProducts = response.data;
				buildBuyProductTable();

				$("#sort_by_select").change(function() {
					buildBuyProductTable();
				});

				$("#sort_order_select").change(function() {
					buildBuyProductTable();
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function buildBuyProductTable() {
		let productsTable = document.getElementById("product_table");
		let sortBy = $("#sort_by_select").val();
		let sortPriority = $("#sort_order_select").val();

		let products = userProducts.sort(function(product1, product2) {
			switch (sortBy) {
				case "nome":
					return (sortPriority == "crescente") ? product1.name > product2.name : product1.name < product2.name;
					break;

				case "preco":
					return (sortPriority == "crescente") ? product1.price > product2.price : product1.price < product2.price;
					break;
			}
		});

		productsTable.innerHTML = "";
		if (products.length > 0) {
			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderProductName = document.createElement('th');
			tableHeaderProductName.innerHTML = "Produto";

			let tableHeaderProductDescription = document.createElement('th');
			tableHeaderProductDescription.innerHTML = "Descrição";

			let tableHeaderProductPrice = document.createElement('th');
			tableHeaderProductPrice.innerHTML = "Preço";

			productsTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderProductName);
			tableHeaderRow.append(tableHeaderProductDescription);
			tableHeaderRow.append(tableHeaderProductPrice);

			products.forEach(function(product) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataProductName = document.createElement('td');
				tableDataProductName.setAttribute('class', "service_table_data");
				tableDataProductName.innerHTML = product.name;

				let tableDataProductDescription = document.createElement('td');
				tableDataProductDescription.setAttribute('class', "service_table_data");
				tableDataProductDescription.innerHTML = product.description;

				let tableDataProductPrice = document.createElement('td');
				tableDataProductPrice.setAttribute('class', "service_table_data");
				tableDataProductPrice.innerHTML = "R$ " + Number(product.price).toFixed(2);

				let productDetailtA = document.createElement('a');
				productDetailtA.setAttribute('onclick','showProductInfo("' + product.id + '")');

				let productDetailImage = document.createElement('img');
				productDetailImage.src = "icons/clipboard.png";
				productDetailImage.width = 18;
				productDetailImage.height = 18;
				productDetailImage.style.paddingTop = "4px";
				productDetailImage.style.paddingRight = "4px";

				productsTable.append(tableRow);
				tableRow.append(tableDataProductName);
				tableRow.append(tableDataProductDescription);
				tableRow.append(tableDataProductPrice);
				tableRow.append(productDetailtA);
				productDetailtA.append(productDetailImage);
			});
		} else {
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoProducts = document.createElement('td');
			tableDataNoProducts.setAttribute('class', "service_table_data");
			tableDataNoProducts.innerHTML = "Nenhum produto encontrado";

			productsTable.append(tableRow);
			tableRow.append(tableDataNoProducts);
		}
	}

	function showProductInfo(productId) {
		if (typeof productId == 'undefined' || productId == null) {
			return;
		}

		$(".content").html(siteContent.client.detalhesProduto);

		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: "/products/" + productId,
	        success: function(response) {
	        	let product = response.data;
				$("#product_name_header").html(product.name);
				$("#description_div").html(product.description);
				let max = product.quantity;
				if (userCart[product.id] != null) {
					max -= userCart[product.id];
				}
				$("#product_quantity").attr({"min" : 0, "max" : max});
				$("#price_div").html("R$ " + product.price);
				$("#buy_button").html(product.quantity > 0 ? "Comprar" : "Indisponível");
				$("#buy_button").css("background-color", (product.quantity > 0) ? "#00b214" : "af0000");

				$("#buy_form").on('submit', function(e) {
					e.preventDefault();
					let quantity = Number($("#product_quantity").val());

					if (quantity > 0) {
						if (userCart[productId] == null) {
							userCart[productId] = quantity;
						} else {
							userCart[productId] += quantity;
						}
					}	

					showBuyProduct();
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        	showBuyProduct();
	        }
        });
	}

	function showCart() {
		$(".content").html(siteContent.client.carrinho);

		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: '/products/',
	        success: function(response) {
				userProducts = response.data;
				buildCartTable();

				$("#sort_by_select").change(function() {
					buildCartTable();
				});

				$("#sort_order_select").change(function() {
					buildCartTable();
				});

				$("#buy_button").on('click', function(e) {
					e.preventDefault();

					const data = JSON.stringify({cart: userCart});
					console.log(data);

					$.ajax({
				        type: 'post',
				        contentType: 'application/json',
				        url: '/buy/',
				        data: data,
				        success: function(response) {
							alert(response.message);
							userCart = {};
							showCart();
				        },
				        error: function(response) {
				        	alert(response.responseJSON.message);
				        }
			        });
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function buildCartTable() {
		let productsTable = document.getElementById("cart_table");
		let sortBy = $("#sort_by_select").val();
		let sortPriority = $("#sort_order_select").val();

		let products = [];

		for (let productId in userCart) {
			let quantity = userCart[productId];
			let product = userProducts.find(function(product) {
				return product.id == productId;
			});
			if (typeof product == 'undefined') {
				return;
			}
			product.quantity = quantity;
			products.push(product);
		}

		products = products.sort(function(product1, product2) {
			switch (sortBy) {
				case "nome":
					return (sortPriority == "crescente") ? product1.name > product2.name : product1.name < product2.name;
					break;

				case "quantidade":
					return (sortPriority == "crescente") ? product1.quantity > product2.quantity : product1.quantity < product2.quantity;
					break;

				case "preco":
					return (sortPriority == "crescente") ? product1.price > product2.price : product1.price < product2.price;
					break;

				case "precoTotal":
					let total1 = product1.price * product1.quantity;
					let total2 = product2.price * product2.quantity;
					return (sortPriority == "crescente") ? total1 > total2 : total1 < total2;
					break;
			}
		});

		productsTable.innerHTML = "";
		if (products.length > 0) {
			$("#clear_cart_button").on('click', function(e) {
				if (window.confirm("Deseja limpar o carrinho?")) {
					userCart = {};
					buildCartTable();
				}
			});
			let totalPrice = 0.0;

			let tableHeaderRow = document.createElement('tr');
			tableHeaderRow.setAttribute('class', "service_table_row");

			let tableHeaderProductName = document.createElement('th');
			tableHeaderProductName.innerHTML = "Produto";

			let tableHeaderProductQuantity = document.createElement('th');
			tableHeaderProductQuantity.innerHTML = "Quantidade";

			let tableHeaderProductPrice = document.createElement('th');
			tableHeaderProductPrice.innerHTML = "Preço";

			let tableHeaderProductTotalPrice = document.createElement('th');
			tableHeaderProductTotalPrice.innerHTML = "Total";

			productsTable.append(tableHeaderRow);
			tableHeaderRow.append(tableHeaderProductName);
			tableHeaderRow.append(tableHeaderProductQuantity);
			tableHeaderRow.append(tableHeaderProductPrice);
			tableHeaderRow.append(tableHeaderProductTotalPrice);

			products.forEach(function(product) {
				let tableRow = document.createElement('tr');
				tableRow.setAttribute('class', "service_table_row");

				let tableDataProductName = document.createElement('td');
				tableDataProductName.setAttribute('class', "service_table_data");
				tableDataProductName.innerHTML = product.name;

				let tableDataProductQuantity = document.createElement('td');
				tableDataProductQuantity.setAttribute('class', "service_table_data");
				tableDataProductQuantity.innerHTML = product.quantity;

				let tableDataProductPrice = document.createElement('td');
				tableDataProductPrice.setAttribute('class', "service_table_data");
				tableDataProductPrice.innerHTML = "R$ " + Number(product.price).toFixed(2);

				let tableDataProductTotalPrice = document.createElement('td');
				tableDataProductTotalPrice.setAttribute('class', "service_table_data");
				tableDataProductTotalPrice.innerHTML = "R$ " + Number(product.price * Number(product.quantity)).toFixed(2);
				totalPrice += product.price * Number(product.quantity);

				let productRemoveA = document.createElement('a');
				productRemoveA.setAttribute('onclick','removeProductFromCart("' + product.id + '")');

				let productRemoveImage = document.createElement('img');
				productRemoveImage.src = "icons/delete.png";
				productRemoveImage.width = 18;
				productRemoveImage.height = 18;
				productRemoveImage.style.paddingTop = "4px";
				productRemoveImage.style.paddingRight = "4px";

				productsTable.append(tableRow);
				tableRow.append(tableDataProductName);
				tableRow.append(tableDataProductQuantity);
				tableRow.append(tableDataProductPrice);
				tableRow.append(tableDataProductTotalPrice);
				tableRow.append(productRemoveA);
				productRemoveA.append(productRemoveImage);
			});
			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataTotal = document.createElement('td');
			tableDataTotal.setAttribute('class', "service_table_data");
			tableDataTotal.innerHTML = "Total";

			let tableDataTotalPrice = document.createElement('td');
			tableDataTotalPrice.setAttribute('class', "service_table_data");
			tableDataTotalPrice.innerHTML = "R$" + totalPrice;

			productsTable.append(tableRow);
			productsTable.append(tableDataTotal);
			productsTable.append(tableDataTotalPrice);
		} else {
			$("#buy_button").css('display', 'none');
			$("#clear_cart_button").css('display', 'none');

			let tableRow = document.createElement('tr');
			tableRow.setAttribute('class', "service_table_row");

			let tableDataNoProducts = document.createElement('td');
			tableDataNoProducts.setAttribute('class', "service_table_data");
			tableDataNoProducts.innerHTML = "Carrinho vazio";

			productsTable.append(tableRow);
			tableRow.append(tableDataNoProducts);
		}
	}

	function removeProductFromCart(productId) {
		if (window.confirm("Deseja remover o produto do carrinho?")) {
			delete userCart[productId];
			buildCartTable();
		}
	}

	function showEditUser() {
		$(".content").html(siteContent.client.editarRegistro);

    	$("#register_name").val(connectedUser.name);
		$("#register_address_phone").val(connectedUser.phone);
		$("#register_address_email").val(connectedUser.email);
		$("#register_address_city").val(connectedUser.city);
		$("#register_address_neighborhood").val(connectedUser.neighborhood);
		$("#register_address_street").val(connectedUser.street);
		$("#editar_registro_form").on('submit', function(e){
			e.preventDefault();
			let name = $("#register_name").val();
			let phone = $("#register_address_phone").val();
			let email = $("#register_address_email").val();
			let city = $("#register_address_city").val();
			let neighborhood = $("#register_address_neighborhood").val();
			let street = $("#register_address_street").val();
			let password = $("#register_password").val();
			let repeatPassword = $("#register_repeat_password").val();

			if (name.length == 0) {
				alert("Por favor insira um nome");
				return;
			} else if (phone.length == 0) {
				alert("Por favor insira um telefone");
				return;
			} else if (email.length == 0) {
				alert("Por favor insira um email");
				return;
			}

			if (password.length > 0 && password != repeatPassword) {
				alert("As senhas estão diferentes.");
				return;
			}

			let user = {
				name: name,
				password: password,
				repeatPassword: repeatPassword,
				email: email,
				phone: phone,
				city: city,
				street: street,
				neighborhood: neighborhood
			};
			const data = JSON.stringify(user);
			$.ajax({
		        type: 'post',
		        contentType: 'application/json',
		        url: "users/" + connectedUser.user,
		        data: data,
		        success: function(response) {
					alert(response.message);
					connectedUser = response.data;
		            setWelcomeMessageName(connectedUser.name);
		        },
		        error: function(response) {
		        	alert(response.responseJSON.message);
		        }
	        });
		});
	}

	function showAnimalManager() {
		$(".content").html(siteContent.client.gerenciarAnimais);
		getAllUserAnimals();
		hideAnimalRegisterForm();
		$('#register_animal_input').click(function(e){
			e.preventDefault();
			didTapRegisterAnimal();
		});
	}

	function getAllUserAnimals() {
		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: "users/" + connectedUser.user + "/animals",
	        success: function(response) {
				let animalsData = response.data;
				let form = document.getElementById("gerenciar_animais_form");
				let oldAnimalsList = document.getElementById("gerenciar_animais_list");
				oldAnimalsList.remove();
				let animalsList = document.createElement('div');
				animalsList.id = "gerenciar_animais_list";
				form.append(animalsList);
				animalsData.forEach(function (animal) {
					let listedAnimalContainerDiv = document.createElement('div');
					listedAnimalContainerDiv.setAttribute('class', "listed_animal_container");

					let animalInfoContainerDiv = document.createElement('div');
					animalInfoContainerDiv.setAttribute('class', "animal_info_container");

					let animalNameSpan = document.createElement('span');
					animalNameSpan.innerHTML = animal.name;

					let iconsContainerDiv = document.createElement('div');
					iconsContainerDiv.setAttribute('class', "icons_container");

					let animalDetailsA = document.createElement('a');
					animalDetailsA.setAttribute('onclick','animalDetailsClick("' + animal.id + '");');

					let animalDetailImage = document.createElement('img');
					animalDetailImage.src = "icons/clipboard.png";

					let animalDeleteA = document.createElement('a');
					animalDeleteA.setAttribute('onclick','deleteAnimalClick("' + animal.name + '", "' + animal.id + '");');

					let animalDeleteImage = document.createElement('img');
					animalDeleteImage.src = "icons/delete.png";

					animalsList.append(listedAnimalContainerDiv);
					listedAnimalContainerDiv.append(animalInfoContainerDiv);
					animalInfoContainerDiv.append(animalNameSpan);
					listedAnimalContainerDiv.append(iconsContainerDiv);
					iconsContainerDiv.append(animalDetailsA);
					animalDetailsA.append(animalDetailImage);
					iconsContainerDiv.append(animalDeleteA);
					animalDeleteA.append(animalDeleteImage);
				});
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function animalDetailsClick(animalId) {
		$.ajax({
	        type: 'get',
	        contentType: 'application/json',
	        url: "animals/" + animalId,
	        success: function(response) {
				let animal = response.data;

				$(".content").html(siteContent.client.visualizarAnimal);
				document.getElementById("animal_name_title").innerText = animal.name;
				document.getElementById("animal_race_title").innerText += animal.species;
				document.getElementById("animal_age_title").innerText += animal.age;

				if (animal.imageData) {
					getImageSrcFromImageData(animal.imageData, function(src) {
						document.getElementById("animal_image").src = src;
					});
				}

				let servicesTable = document.getElementById("service_table");
				if (animal.services.length > 0) {
					let totalPrice = 0.0;
					animal.services.forEach(function (service) {
						let tableRow = document.createElement('tr');
						tableRow.setAttribute('class', "service_table_row");

						let tableDataServiceName = document.createElement('td');
						tableDataServiceName.setAttribute('class', "service_table_data");
						tableDataServiceName.innerHTML = service.name;

						let tableDataServiceDate = document.createElement('td');
						tableDataServiceDate.setAttribute('class', "service_table_data");
						tableDataServiceDate.innerHTML = service.date;

						let tableDataServiceTime = document.createElement('td');
						tableDataServiceTime.setAttribute('class', "service_table_data");
						tableDataServiceTime.innerHTML = service.time;

						let tableDataServicePrice = document.createElement('td');
						tableDataServicePrice.setAttribute('class', "service_table_data");
						tableDataServicePrice.innerHTML = "R$" + service.price;
						totalPrice += service.price;

						servicesTable.append(tableRow);
						servicesTable.append(tableDataServiceName);
						servicesTable.append(tableDataServiceDate);
						servicesTable.append(tableDataServiceTime);
						servicesTable.append(tableDataServicePrice);
					});
					let tableRow = document.createElement('tr');
					tableRow.setAttribute('class', "service_table_row");

					let tableDataTotal = document.createElement('td');
					tableDataTotal.setAttribute('class', "service_table_data");
					tableDataTotal.innerHTML = "Total";

					let tableDataTotalPrice = document.createElement('td');
					tableDataTotalPrice.setAttribute('class', "service_table_data");
					tableDataTotalPrice.innerHTML = "R$" + totalPrice;

					servicesTable.append(tableRow);
					servicesTable.append(tableDataTotal);
					servicesTable.append(tableDataTotalPrice);
				} else {
					let tableRow = document.createElement('tr');
					tableRow.setAttribute('class', "service_table_row");

					let tableDataTotal = document.createElement('td');
					tableDataTotal.setAttribute('class', "service_table_data");
					tableDataTotal.innerHTML = "Nenhum serviço";

					servicesTable.append(tableRow);
					servicesTable.append(tableDataTotal);
				}
	        },
	        error: function(response) {
	        	alert(response.responseJSON.message);
	        }
        });
	}

	function deleteAnimalClick(animalName, animalId) {
		if(window.confirm("Deseja remover " + animalName + "?")) {
			$.ajax({
		        type: 'delete',
		        contentType: 'application/json',
		        url: "animals/" + animalId,
		        success: function(response) {
					getAllUserAnimals();
		        },
		        error: function(response) {
		        	alert(response.responseJSON.message);
		        }
	        });
		}
	}

	function showAnimalRegisterForm() {
		document.getElementById("animal_register_form").style.display = "initial";
		document.getElementById("animal_name_field").value = "";
		document.getElementById("animal_race_field").value = "";
	}

	function didTapRegisterAnimal() {
		const name = document.getElementById("animal_name_field").value;
		const race = document.getElementById("animal_race_field").value;
		const age = Number(document.getElementById("animal_age_field").value);
		const files = document.getElementById("animal_image_field").files;
		let imageData = null;
		let imagePromise = null;

		if (name.length == 0 && race.length == 0) {
			hideAnimalRegisterForm();
			return;
		} else if (name.length == 0) {
			alert("Por favor digite um nome.");
			return;
		} else if (race.length == 0) {
			alert("Por favor digite uma raça.");
			return;
		}

		if (files && files.length > 0) {
			image = files[0];
	        const reader = new FileReader();

	        imagePromise = new Promise(function(resolve, reject) {
	        	reader.onload = function(e) {
		            const binaryString = e.target.result;
		            console.log(binaryString);
		            imageData = binaryString;
		            resolve();
		        };
	        });
	        reader.readAsDataURL(image);
		}

		let promises = [];
		if (imagePromise != null) {
			promises.push(imagePromise);
		}

		Promise.all(promises).then(function() {
			let animal = {
				name: name,
				species: race,
				age: age,
				owner: connectedUser.user
			};
			if (imageData) {
				animal.imageData = imageData;
			}
			const data = JSON.stringify(animal);
			$.ajax({
		        type: 'post',
		        contentType: 'application/json',
		        url: 'animals/',
		        data: data,
		        success: function(response) {
					hideAnimalRegisterForm();
					getAllUserAnimals();
					alert(response.message);
		        },
		        error: function(response) {
		        	alert(response.responseJSON.message);
		        }
	        });
		});
	}

	function hideAnimalRegisterForm() {
		document.getElementById("animal_register_form").style.display = "none";
	}
 	</script>
	
	<footer>
		Copyright
		Icons by Freepik of flaticon.com and Alfredo Hernandez of alfredocreates.com
	</footer>
</body>
</html>