
<html>
<head>
	<link rel="stylesheet" type="text/css" href="style.css"> 
	<link rel="stylesheet" type="text/css" href="titles.css"> 
	<link rel="stylesheet" type="text/css" href="menus.css"> 
	<link rel="stylesheet" type="text/css" href="forms.css"> 
	<link rel="stylesheet" type="text/css" href="animal_details.css">

	<!--<link rel="stylsheet" type="text/css" href="control_panel.css">-->
	 <meta charset="utf-8"></meta>
</head>
<body>
	<header>
		<h1 class="site_title">%Pet Shop Name%</h1>
	</header>

	<nav>
		<ul class="horizontal_menu">

		</ul>
	</nav>
<!--
	<nav>
		<ul class="side_menu">
			<li class="side_menu_item">Funcionalidade 1</li>
			<li class="side_menu_item">Funcionalidade 2</li>
			<li class="side_menu_item">Funcionalidade 3</li>
			<li class="side_menu_item">Funcionalidade 4</li>
			<li class="side_menu_item">Funcionalidade 5</li>
			<li class="side_menu_item">Funcionalidade 6</li>
		</ul>
	</nav>
-->
	<main class="content">

	</main>
 	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="site_content.js"></script>

 	<script type="text/javascript">

 	var indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB || window.shimIndexedDB;

	const databaseName = "Database";
	const databaseUsersName = "Usuarios";
	const databasePetsName = "Animais";
	const DadosUsuarios = [
		{
			usuario: "admin",
			nome: "Bill",
			senha: "password",
			email: "bill@company.com",
			telefone: "9999-9999",
			cidade:"são carlos",
			rua: "whatever",
			bairro: "saida da mat",
			isAdmin: true
		},
		{
			usuario: "client",
			nome: "John",
			senha: "1234",
			email: "john@company.com",
			telefone: "9999-9999",
			cidade:"são carlos",
			rua: "whatever",
			bairro: "saida da mat",
			isAdmin: false
		}
	];
	const DadosAnimais =[
		{
			nome: "Billy",
			especie: "Cachorro",
			dono: "client",
			idade: 5
		},
		{
			nome: "Lua",
			especie: "Gato",
			dono: "client",
			idade: 9
		},
		{
			nome: "Per",
			especie: "Gato",
			dono: "client",
			idade: 1
		}
	];
	var request = indexedDB.deleteDatabase(databaseName);
	var request = indexedDB.open(databaseName, 2);
	var connection;
	var connectedUser = "";

	request.onerror = function(event) {
		alert("Falha na conexão com o servidor");
	};

	request.onupgradeneeded = function(event) {
		let db = event.target.result;

		let usuariosObjectStore = db.createObjectStore(databaseUsersName, { keyPath: 'usuario' });
		usuariosObjectStore.createIndex("usuario", "usuario", { unique: true });

		for (let i in DadosUsuarios) {
			let aux = usuariosObjectStore.put(DadosUsuarios[i]);
		}

		let animalsObjectStore = db.createObjectStore(databasePetsName,  {keyPath: 'id', autoIncrement: true });
		animalsObjectStore.createIndex("id", "id", { unique: true });
		animalsObjectStore.createIndex("nome", "nome", { unique: false });
		animalsObjectStore.createIndex("dono", "dono", { unique: false });

		for (let i in DadosAnimais) {
			let aux = animalsObjectStore.put(DadosAnimais[i]);
		}
	};

	request.onsuccess = function(event) {
		connection = event.target.result;
	};


 	let client = false;
	$(document).ready(
		function() {
			if(!client) {
				$(".horizontal_menu").html(horizontalMenu.index)
				$(".content").html(siteContent.index);
				$('#login_form').on('submit', function(e){
					e.preventDefault();
					loginClick();
				});
			}
		}
	);

	function loginClick() {
		var tx = connection.transaction(databaseUsersName, "readonly");
    	var objectStore = tx.objectStore(databaseUsersName);
    	var usernameValue = document.getElementById("login_username").value;
    	var passwordValue = document.getElementById("login_password").value;
    	var request = objectStore.index("usuario").get(usernameValue);
    	request.onsuccess = function(event) {
		    if (typeof event.target.result == 'undefined') {
		        alert("Usuário e/ou senha inválido");
		        return;
		    } else if (event.target.result.senha != passwordValue) {
		    	alert("Usuário e/ou senha inválido");
		    	return;
		    } else {
		    	connectedUser = event.target.result.usuario;
				$(".horizontal_menu").html(horizontalMenu.client);
				$(".content").html(siteContent.client.agendarHorario);
				setWelcomeMessageName(event.target.result.nome);
		    }
		};
	}

	function logout() {
		connectedUser = "";
		$("#user_login_box").remove();
		$(".content").html(siteContent.index);
		$(".horizontal_menu").html(horizontalMenu.index);
		$('#login_form').on('submit', function(e){
			e.preventDefault();
			loginClick();
		});
	}

	function menuClick(component) {
		switch(component.attributes.tab.value) {
			case "agendarHorario":
				$(".content").html(siteContent.client.agendarHorario);
				break;
			case "comprarProduto":
				$(".content").html(siteContent.client.comprarProduto);
				break;
			case "editarRegistro":
				editRegister();
				break;
			case "gerenciarAnimais":
				manageAnimals();
				break;
		}		
	}

	function setWelcomeMessageName(name) {
		$("#user_login_box").remove();
		$("header").append(siteContent.logoutBox);
		$("#welcome_span").html($("#welcome_span").html().replace("user_name", name));
		$('#logout').click(function(e){
			e.preventDefault();
			logout();
		});
	}

	function editRegister() {
		$(".content").html(siteContent.client.editarRegistro);
		var tx = connection.transaction(databaseUsersName, "readonly");
		var objectStore = tx.objectStore(databaseUsersName);
		var request = objectStore.index("usuario").get(connectedUser);
    	request.onsuccess = function(event) {
    		let userInfo = event.target.result;
		    if (typeof userInfo != 'undefined') {
		    	$("#register_name").val(userInfo.nome);
				$("#register_address_phone").val(userInfo.telefone);
				$("#register_address_email").val(userInfo.email);
				$("#register_address_city").val(userInfo.cidade);
				$("#register_address_neighborhood").val(userInfo.bairro);
				$("#register_address_street").val(userInfo.rua);
				$("#editar_registro_form").on('submit', function(e){
					e.preventDefault();
					let nome = $("#register_name").val();
					let telefone = $("#register_address_phone").val();
					let email = $("#register_address_email").val();
					let cidade = $("#register_address_city").val();
					let bairro = $("#register_address_neighborhood").val();
					let rua = $("#register_address_street").val();
					let senha = $("#register_password").val();
					let repetirSenha = $("#register_repeat_password").val();

					if (senha.length > 0 && senha != repetirSenha) {
						alert("As senhas estão diferentes.");
						return;
					}

					userInfo.nome = nome;
					userInfo.telefone = telefone;
					userInfo.email = email;
					userInfo.cidade = cidade;
					userInfo.bairro = bairro;
					userInfo.rua = rua;
					if (senha.length > 0) {
						userInfo.senha = senha;
					}

					let request = connection.transaction(databaseUsersName, "readwrite").objectStore(databaseUsersName).put(userInfo);
					request.onsuccess = function(e){
			            alert("Cadastro atualizado!");
			            setWelcomeMessageName(userInfo.nome);
			        };

			        request.onerror = function(e){
			            alert("Erro ao atualizar cadastro, tente novamente.");
			        };
				});
		    } else {
		    	alert("Erro ao recuperar informações do usuário, por favor tente novamente.");
		    }
		};
	}

	function manageAnimals() {
		$(".content").html(siteContent.client.gerenciarAnimais);
		getAllUserAnimals();
	}

	function getAllUserAnimals() {
		var tx = connection.transaction(databasePetsName, "readonly");
		var objectStore = tx.objectStore(databasePetsName);
		var request = objectStore.index("dono").getAll(connectedUser);
		request.onsuccess = function(event) {
			let animalsData = event.target.result;
			if (typeof animalsData != 'undefined') {
				let form = document.getElementById("gerenciar_animais_form");
				let oldAnimalsList = document.getElementById("gerenciar_animais_list");
				oldAnimalsList.remove();
				let animalsList = document.createElement('div');
				animalsList.id = "gerenciar_animais_list";
				form.append(animalsList);
				animalsData.forEach(function (animal) {
					console.log(animal);
					let listedAnimalContainerDiv = document.createElement('div');
					listedAnimalContainerDiv.setAttribute('class', "listed_animal_container");

					let animalInfoContainerDiv = document.createElement('div');
					animalInfoContainerDiv.setAttribute('class', "animal_info_container");

					let animalNameSpan = document.createElement('span');
					animalNameSpan.innerHTML = animal.nome;

					let iconsContainerDiv = document.createElement('div');
					iconsContainerDiv.setAttribute('class', "icons_container");

					let animalDetailsA = document.createElement('a');
					animalDetailsA.setAttribute('onclick','animalDetailsClick(' + animal.id + ');');

					let animalDetailImage = document.createElement('img');
					animalDetailImage.src = "icons/clipboard.png";

					let animalDeleteA = document.createElement('a');
					animalDeleteA.setAttribute('onclick','deleteAnimalClick("' + animal.nome + '", ' + animal.id + ');');

					let animalDeleteImage = document.createElement('img');
					animalDeleteImage.src = "icons/delete.png";

					animalsList.append(listedAnimalContainerDiv);
					listedAnimalContainerDiv.append(animalInfoContainerDiv);
					animalInfoContainerDiv.append(animalNameSpan);
					listedAnimalContainerDiv.append(iconsContainerDiv);
					iconsContainerDiv.append(animalDetailsA);
					animalDetailsA.append(animalDetailImage);
					iconsContainerDiv.append(animalDeleteA);
					animalDeleteA.append(animalDeleteImage);
				});
			}
		};
	}

	function animalDetailsClick(animalId) {
		console.log(e);
	}

	function deleteAnimalClick(animalName, animalId) {
		if(window.confirm("Deseja remover " + animalName + "?")) {
			var tx = connection.transaction(databasePetsName, "readwrite");
			var objectStore = tx.objectStore(databasePetsName);
			let request = objectStore.delete(animalId);
			request.onsuccess = function(e) {
				getAllUserAnimals();
			};
		}
	}

	function showAnimalRegisterForm() {
		let form = document.createElement('form');
		form.id = "animal_register_form";

		let nameLabelContainerDiv = document.createElement('div');
		nameLabelContainerDiv.setAttribute('class', "label_container");

		let nameLabel = document.createElement('label');
		nameLabel.for = "animal_name_field";

		let nameSpan = document.createElement('span');
		nameSpan.innerHTML = "Nome: ";

		let nameFieldContainer = document.createElement('div');
		nameFieldContainer.setAttribute('class', "field_container");

		let nameInput = document.createElement('input');
		nameInput.id = "animal_name_field";

		let speciesLabelContainerDiv = document.createElement('div');
		speciesLabelContainerDiv.setAttribute('class', "label_container");

		let speciesLabel = document.createElement('label');
		speciesLabel.for = "animal_race_field";

		let speciesSpan = document.createElement('span');
		speciesSpan.innerHTML = "Espécie: ";

		let speciesFieldContainer = document.createElement('div');
		speciesFieldContainer.setAttribute('class', "field_container");

		let speciesInput = document.createElement('input');
		speciesInput.id = "animal_race_field";

		let submitContainerDiv = document.createElement('div');
		submitContainerDiv.setAttribute('class', "submit_container");

		let submitInput = document.createElement('input');
		submitInput.type = "submit";
		submitInput.value = "Enviar";
		submitInput.setAttribute('onclick','hideAnimalRegisterForm();');

		let animalsForm = document.getElementById("cadastrar_animal_button");
		animalsForm.append(form);
		
		form.append(nameLabelContainerDiv);
		nameLabelContainerDiv.append(nameLabel);
		nameLabel.append(nameSpan);
		form.append(nameFieldContainer);
		nameFieldContainer.append(nameInput);

		form.append(speciesLabelContainerDiv);
		speciesLabelContainerDiv.append(speciesLabel);
		speciesLabel.append(speciesSpan);
		form.append(speciesFieldContainer);
		speciesFieldContainer.append(speciesInput);

		form.append(submitContainerDiv);
		submitContainerDiv.append(submitInput);
	}

	function hideAnimalRegisterForm() {
		let form = document.getElementById("animal_register_form");
		form.remove();
	}

	var slideIndex = 1;
	showDivs(slideIndex);

	function plusDivs(n) {
	    showDivs(slideIndex += n);
	}

	function showDivs(n) {
	    var i;
	    var x = document.getElementsByClassName("mySlides");
	    if (n > x.length) {slideIndex = 1}
	    if (n < 1) {slideIndex = x.length} ;
	    for (i = 0; i < x.length; i++) {
	        x[i].style.display = "none";
	    }
	    x[slideIndex-1].style.display = "block";
	}


 	</script>
	
	<footer>
		Copyright
		Icons by Freepik of flaticon.com and Alfredo Hernandez of alfredocreates.com
	</footer>

</body>
</html>
